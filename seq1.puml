@startuml
actor Клиент
participant "individuals-api" as API
participant "person-service" as PersonService
database "PostgreSQL" as DB
participant "Keycloak" as Keycloak

== Успешная регистрация ==

Клиент -> API: POST /register
activate API

API -> PersonService: POST /users (createUser)
activate PersonService
PersonService -> DB: Начать транзакцию
PersonService -> DB: INSERT individual
PersonService -> DB: INSERT user
PersonService -> DB: INSERT address
PersonService -> DB: Зафиксировать транзакцию
DB --> PersonService: user_uid
PersonService --> API: 201 Created (user_uid)
deactivate PersonService

API -> Keycloak: POST /users (с user_uid в атрибутах)
activate Keycloak
Keycloak --> API: 201 Created
deactivate Keycloak

API -> API: Сохранить состояние саги
API --> Клиент: 201 Created
deactivate API

== Ошибка регистрации в Keycloak ==

Клиент -> API: POST /register
activate API

API -> PersonService: POST /users (createUser)
activate PersonService
PersonService -> DB: Транзакция создания
DB --> PersonService: user_uid
PersonService --> API: 201 Created (user_uid)
deactivate PersonService

API -> Keycloak: POST /users
activate Keycloak
Keycloak --> API: 500 Error
deactivate Keycloak

API -> PersonService: POST /users/{user_uid}/compensate
activate PersonService
PersonService -> DB: Начать транзакцию
PersonService -> DB: DELETE address
PersonService -> DB: DELETE user
PersonService -> DB: DELETE individual
PersonService -> DB: Зафиксировать транзакцию
DB --> PersonService: Success
PersonService --> API: 200 OK
deactivate PersonService

API --> Клиент: 500 Registration Error
deactivate API

@enduml